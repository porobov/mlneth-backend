#!/usr/bin/env python
# -*- coding: utf-8 -*-

import pytest
from hexbytes import HexBytes
from mlneth_backend.events_loader import load_events_logs, decode_log, format_log

__author__ = "porobov"
__copyright__ = "porobov"
__license__ = "mit"

@pytest.mark.skip(reason="no need to test infura every time")
def test_infura():
    assert load_events_logs('NonExistingEventName', 4315137, 4315137) == []
    real_events_from_infura = load_events_logs('NewImage', 4315137, 4315137)
    assert real_events_from_infura == [{'address': '0x15dbdB25f870f21eaf9105e68e249E0426DaE916', 'blockHash': HexBytes('0x9dde019baa9de6297868f52135c493901841817b2b570d01c4e414b6cb49846f'), 'blockNumber': 4315137, 'data': '0x00000000000000000000000000000000000000000000000000000000000000420000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000002d000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000270000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000001968747470733a2f2f696d6775722e636f6d2f3663554c61635700000000000000000000000000000000000000000000000000000000000000000000000000002968747470733a2f2f7777772e436f696e6d616d612e636f6d2f3f7265663d68616d73746572393131340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004142555920424954434f494e532057495448204352454449542043415244204f5220434153482120494e204d494e5554455321204020434f494e4d414d412e636f6d00000000000000000000000000000000000000000000000000000000000000', 'logIndex': 14, 'removed': False, 'topics': [HexBytes('0x542d3e34836f8b331e8441364480130cf7077e9b6ae9dab76dc285dd3961b0a6')], 'transactionHash': HexBytes('0x88881ae6396a79f841683f26365f331a2584adfa1ea36ca4051596801909091d'), 'transactionIndex': 90}]
    unformatted_log = real_events_from_infura[0]
    assert map_log(decode_log('NewImage', unformatted_log)) == {'block_number': 4315137, 'transaction_index': 90, 'id': 66, 'x1': 50, 'y1': 45, 'x2': 52, 'y2': 39, 'src': 'https://imgur.com/6cULacW', 'href': 'https://www.Coinmama.com/?ref=hamster9114', 'alt': 'BUY BITCOINS WITH CREDIT CARD OR CASH! IN MINUTES! @ COINMAMA.com'}
    
 
def test_decode_log():
    log = [{'address': '0x15dbdB25f870f21eaf9105e68e249E0426DaE916', 'blockHash': HexBytes('0x9dde019baa9de6297868f52135c493901841817b2b570d01c4e414b6cb49846f'), 'blockNumber': 4315137, 'data': '0x00000000000000000000000000000000000000000000000000000000000000420000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000002d000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000270000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000001968747470733a2f2f696d6775722e636f6d2f3663554c61635700000000000000000000000000000000000000000000000000000000000000000000000000002968747470733a2f2f7777772e436f696e6d616d612e636f6d2f3f7265663d68616d73746572393131340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004142555920424954434f494e532057495448204352454449542043415244204f5220434153482120494e204d494e5554455321204020434f494e4d414d412e636f6d00000000000000000000000000000000000000000000000000000000000000', 'logIndex': 14, 'removed': False, 'topics': [HexBytes('0x542d3e34836f8b331e8441364480130cf7077e9b6ae9dab76dc285dd3961b0a6')], 'transactionHash': HexBytes('0x88881ae6396a79f841683f26365f331a2584adfa1ea36ca4051596801909091d'), 'transactionIndex': 90}]
    assert decode_log('NewImage', log[0]) == {'event': 'NewImage', 'block_number': 4315137, 'transaction_index': 90, 'ID': 66, 'fromX': 50, 'fromY': 45, 'toX': 52, 'toY': 39, 'imageSourceUrl': 'https://imgur.com/6cULacW', 'adUrl': 'https://www.Coinmama.com/?ref=hamster9114', 'adText': 'BUY BITCOINS WITH CREDIT CARD OR CASH! IN MINUTES! @ COINMAMA.com'}
# def test_fib():
#     assert fib(1) == 1
#     assert fib(2) == 1
#     assert fib(7) == 13
#     with pytest.raises(AssertionError):
#         fib(-10)
